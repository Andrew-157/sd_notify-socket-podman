# sd_notify and podman
* [Motivation](#motivation)

## Motivation

The motivation for this repository was that I wanted to understand how podman's Quadlet systemd service manages a container lifetime. Quadlet allows you to create a file with syntax very similar to systemd's unit files.

Exemplary Quadlet container file:

```ini
[Unit]
Description=A minimal container

[Container]
Image=registry.access.redhat.com/ubi9:latest
# In the container we just run sleep
Exec=sleep inf

[Service]
# Restart service when sleep finishes
Restart=always
TimeoutStartSec=900

[Install]
# Start by default on boot
WantedBy=multi-user.target default.target
```

You put the contents above into `/etc/containers/systemd`, run `systemctl daemon-reload` and podman will generate a systemd unit that looks something like that:

```ini
# /run/systemd/generator/test.service                                                                                                                          
# Automatically generated by /usr/lib/systemd/system-generators/podman-system-generator                                                                                                                                                
#                          
[Unit]                     
Wants=network-online.target    
After=network-online.target                                                                       
Description=A minimal container                                                
SourcePath=/etc/containers/systemd/test.container                                                                                                                                                   
# /run/systemd/generator/test.service            
# Automatically generated by /usr/lib/systemd/system-generators/podman-system-generator                                                                                                                                                
#                                                                              
[Unit]                              
Wants=network-online.target    
After=network-online.target                                                                       
Description=A minimal container
SourcePath=/etc/containers/systemd/test.container                                                                  
# /run/systemd/generator/test.service
# Automatically generated by /usr/lib/systemd/system-generators/podman-system-generator                                                                                                                                                
#                                   
[Unit]        
Wants=network-online.target                                                    
After=network-online.target                                                    
Description=A minimal container      
SourcePath=/etc/containers/systemd/test.container                                                                  
RequiresMountsFor=%t/containers
                                       
[X-Container]                                                                                                                                                  
Image=registry.access.redhat.com/ubi9:latest                                                      
# In the container we just run sleep                                                              
Exec=sleep inf            
                                                                               
[Service]                                        
# Restart service when sleep finishes                                          
Restart=always                                                                                                                                                                                      
TimeoutStartSec=900                                                            
Environment=PODMAN_SYSTEMD_UNIT=%n
KillMode=mixed                                                                 
ExecStop=/usr/bin/podman rm -v -f -i systemd-%N                               
ExecStopPost=-/usr/bin/podman rm -v -f -i systemd-%N                           
Delegate=yes                                                                                                                                                   
Type=notify                                                                                       
NotifyAccess=all                                                                                  
SyslogIdentifier=%N                              
ExecStart=/usr/bin/podman run --name systemd-%N --replace --rm --cgroups=split --sdnotify=conmon -d registry.access.redhat.com/ubi9:latest sleep inf                                                                                   
                                                                                                  
[Install]                                                                                         
# Start by default on boot                                                                                                                                                                          
WantedBy=multi-user.target default.target                                                                          

# /usr/lib/systemd/system/service.d/10-timeout-abort.conf                                                          
# This file is part of the systemd package.                                                                        
# See https://fedoraproject.org/wiki/Changes/Shorter_Shutdown_Timer.                                               
#                                                        
# To facilitate debugging when a service fails to stop cleanly,                                                    
# TimeoutStopFailureMode=abort is set to "crash" services that fail to stop in                                     
# the time allotted. This will cause the service to be terminated with SIGABRT
```

If you start the service `test.service`, the container `systemd-test` will be started. If you stop `systemd-test`, the above service will restart the container(actually, it will completely recreate the container, but that's not the point). How it is done? How does `test.service` know that `test-systemd` went down. This is done with the service's Type "notify" and with podman run's option "--sdnotify=conmon".

I was interested how that worked, so I created that repo. This is not really a project, this is more of a research for me.

